---
layout:     post
title:      [Google TPU from zero]
subtitle:   [30-days free TPU to go]
date:       [2023-04-09]
author:     J.C.
header-img: img/post-bg-article.jpg
catalog: true
tags:
    - ML
onTop: false
comments: true
---

Step 1 : [Install Google Cloud CLI](https://cloud.google.com/sdk/docs/install?hl=zh-cn) on powershell

```shell
(New-Object Net.WebClient).DownloadFile("https://dl.google.com/dl/cloudsdk/channels/rapid/GoogleCloudSDKInstaller.exe", "$env:Temp\GoogleCloudSDKInstaller.exe")

& $env:Temp\GoogleCloudSDKInstaller.exe
```

**Optional** : There is limited connection in China. I got `ERROR: gcloud crashed (SSLError): HTTPSConnectionPool(host='oauth2.googleapis.com', port=443): Max retries exceeded with url` under the education networking.

So I use `clash-for-windows` for [gloud proxy](https://cloud.google.com/sdk/docs/proxy-settings?hl=zh-cn). 

```shell
gcloud config set proxy/type http

gcloud config set proxy/address 127.0.0.1

gcloud config set proxy/port 7890
```

Then login gcloud, confirm the redirection buttom, successed if the CLI output the `You are now logged in as [MyAccount].
Your current project is [MyProject].  You can change this setting by running.` 
```shell
gcloud auth login
```

Set Google cloud project

```shell
gcloud config set project <your-project-id>
gcloud config set account <your-email-account>
```

Step 2 : Create TPU Virtual Machine

Check your dependencies. Verify your torch version and torch-related packages version.

```shell
pip3 list | grep torch
```

E.g. I use `pytorch-forecasting==0.10.2` and `pytorch-lightning==1.7.2` for my project. Then I got torch requirements by querying in *www.pypi.org*. And ues the latest one in [supported torch version](https://cloud.google.com/tpu/docs/supported-tpu-versions?hl=zh-cn#pytorch). Free trial GPU table here, you can find it in TRC response letter.

TPU Type| Use Type | Num | Zone
---|---|--- |---
 v2-8 | on-demand | 5 | us-central1-f
 v3-8 | on-demand | 5 | europe-west4-a
 v2-8 | preemptible | 100 | us-central1-f

Then fill the follow command by the table. Create a TPU VM.

```shell
gcloud compute tpus tpu-vm create <your-tpu-name> --zone=us-central1-f --accelerator-type=v2-8 --version=tpu-vm-pt-1.10
```

Use ssh to connect the VM your have created.

```shell
gcloud compute tpus tpu-vm ssh <your-tpu-name> --zone us-central1-f --project <project-id>
```

Set PJRT

```shell
export PJRT_DEVICE=TPU
```

**High-freq Commands**. Save the instructions into a file or an alias.

|Goal|Command|
---|---
| Stop | gcloud compute tpus tpu-vm stop your-tpu-name --zone=zone
| Start | gcloud compute tpus tpu-vm start your-tpu-name --zone  zone
| Delete | gcloud compute tpus tpu-vm delete your-tpu-name --zone=zone |
| List | gcloud compute tpus tpu-vm list --zone=zone
| Search | gcloud compute tpus tpu-vm describe your-tpu-name --zone=zone

Step 3 : Use XShell to connect

- Go to google cloud console, click `Compute Engie` on the right bar, then `TPU`, Copy the external IP.

- Then, go to the localtion that store your ssh key-pairs which are generated by putty, namely `google_compute_engine.ppk`. 

- Use `Putty key gen` to export a private key.

- Create a new session on XShell with specificed `Connection->Proxy` and `Connection->User Auth->Method->Pub Key`